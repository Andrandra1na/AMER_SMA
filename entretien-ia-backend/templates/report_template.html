<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Rapport d'Entretien - {{ data.session_info.candidat_nom }}</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

        @page {
            size: A4;
            margin: 1.5cm;
        }

        :root {
            --color-primary: #005f73;
            --color-secondary: #0a9396;
            --color-accent: #94d2bd;
            --color-text: #333333;
            --color-text-light: #6c757d;
            --color-background: #f8f9fa;
            --color-border: #dee2e6;
        }

        body {
            font-family: 'Poppins', sans-serif;
            font-size: 10pt;
            line-height: 1.5;
            color: var(--color-text);
        }
        h1, h2, h3 {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            color: var(--color-primary);
        }
        h1 { font-size: 22pt; margin-bottom: 0.5em; text-align: center; }
        h2 { font-size: 16pt; border-bottom: 2px solid var(--color-primary); padding-bottom: 5px; margin-top: 25px; margin-bottom: 15px;}
        h3 { font-size: 13pt; color: var(--color-secondary); margin-top: 20px; margin-bottom: 10px; border-left: 3px solid var(--color-accent); padding-left: 10px;}

        #header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 15px;
            margin-bottom: 30px;
        }
        #header .logo-text { font-size: 18pt; font-weight: 600; color: var(--color-primary); }
        #header .info-candidat { text-align: right; font-size: 9pt; line-height: 1.6; }
        
        /* Cartes de métriques (KPI) */
        .kpi-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr; /* 4 colonnes égales */
            gap: 15px;
            margin-bottom: 20px;
        }
        .kpi-card {
            background-color: var(--color-background);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .kpi-card .label {
            font-size: 9pt;
            color: var(--color-text-light);
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        .kpi-card .value {
            font-size: 20pt;
            font-weight: 600;
            color: var(--color-primary);
        }

        /* Blocs de question/réponse */
        .question-block {
            page-break-inside: avoid; /* Évite de couper un bloc entre deux pages */
            margin-bottom: 25px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 15px;
        }
        .question-block blockquote {
            background-color: #f8f9fa;
            border-left: 4px solid var(--color-accent);
            padding: 10px 15px;
            margin: 10px 0;
            font-style: italic;
            color: var(--color-text-light);
        }
        
        /* Barres de progression pour les scores */
        .score-bar-container {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 5px;
            margin-top: 5px;
            height: 18px; /* Hauteur fixe pour la barre */
        }
        .score-bar {
            height: 18px;
            border-radius: 5px;
            background-color: var(--color-secondary);
            text-align: right;
            padding-right: 5px;
            color: white;
            font-size: 8pt;
            font-weight: 600;
            line-height: 18px;
            box-sizing: border-box; /* S'assure que le padding ne dépasse pas */
        }
        
        /* Section de validation RH */
        .validation-section { margin-top: 30px; page-break-before: auto; border-top: 2px solid #333; padding-top: 15px; }
        .commentaire-box { background-color: #f0f8ff; border: 1px solid #cce5ff; border-radius: 8px; padding: 15px; margin-top: 10px; }
        .footer-note { text-align: right; font-style: italic; font-size: 9pt; color: #6c757d; margin-top: 20px; }

        .profile-section {
    margin-top: 20px;
    margin-bottom: 20px;
}
        .profile-box {
            background-color: #f0f8ff; /* AliceBlue, pour le distinguer */
            border: 1px solid #cce5ff;
            border-left: 5px solid var(--color-primary);
            border-radius: 8px;
            padding: 15px 20px;
        }
        .profile-box p {
            color: var(--color-text-light);
            font-style: italic;
            margin-top: 5px;
        }

        .profile-section { margin-top: 20px; margin-bottom: 20px; page-break-inside: avoid; }
        .profile-box {
            background-color: #f0f8ff;
            border: 1px solid #cce5ff;
            border-left: 5px solid var(--color-primary);
            border-radius: 8px;
            padding: 15px 20px;
                }
        .profile-box p { color: var(--color-text-light); font-style: italic; margin-top: 5px; }

        .gaze-section { margin-top: 20px; page-break-inside: avoid; }
        .gaze-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .gaze-table th, .gaze-table td { border: 1px solid var(--color-border); padding: 8px; text-align: center; }
        .gaze-table th { background-color: var(--color-background); font-weight: 600; }
        .rag-explanation-box {
            background-color: #f0f4f8; /* Un bleu-gris très clair */
            border: 1px solid #d6e0ea;
            border-radius: 4px;
            padding: 8px 12px;
            margin-top: 10px;
            font-size: 8pt;
            font-style: italic;
            color: #495057;
        }
        .rag-explanation-box strong {
            font-style: normal;
            color: #005f73;
        }
    </style>
</head>
<body>

    <div id="header">
        <span class="logo-text">IntelliHire</span>
        <div class="info-candidat">
            <strong>Candidat :</strong> {{ data.session_info.candidat_nom }}<br>
            <strong>Poste Visé :</strong> {{ data.session_info.poste_vise }}<br>
            <strong>Date :</strong> {{ data.session_info.date }}
        </div>
    </div>

    <h1>Rapport d'Analyse d'Entretien</h1>

    <h2>Synthèse Globale</h2>
    <div class="kpi-container">
        <div class="kpi-card">
            <div class="label">Note Globale IA</div>
            <div class="value">{{ data.global_scores.note_globale|round(0) }}<span style="font-size: 12pt;">/100</span></div>
        </div>
        <div class="kpi-card">
            <div class="label">Émotion Dominante</div>
            <div class="value">{{ data.emotion_scores.dominant_emotion|capitalize }}</div>
        </div>
        <div class="kpi-card">
            <div class="label">Débit de Parole</div>
            <div class="value">{{ data.vocal_analysis.speech_rate|round(0) }}</div>
            <span style="color: var(--color-text-light); font-size: 9pt;">mots/min</span>
        </div>
         <div class="kpi-card">
            <div class="label">Nombre de Pauses</div>
            <div class="value">{{ data.vocal_analysis.pause_count }}</div>
            <span style="color: var(--color-text-light); font-size: 9pt;">(>0.5s)</span>
        </div>
    </div>
    <div class="profile-section">
        <h2>Profil de Communication Détecté</h2>
        <div class="profile-box">
            <h3>{{ data.communication_profile.title }}</h3>
            <p>{{ data.communication_profile.description }}</p>
        </div>
    </div>
    <!-- NOUVEAU : ANALYSE DU REGARD -->
    <div class="gaze-section">
        <h2>Comportement Visuel (Regard)</h2>
        <table class="gaze-table">
            <thead>
                <tr>
                    <th>Comportement</th>
                    <th>Pourcentage Global</th>
                </tr>
            </thead>
            <tbody>
                {% for behavior, percentage in data.gaze_analysis.global_distribution.items() %}
                <tr>
                    <td>{{ behavior }}</td>
                    <td>{{ percentage|round(1) }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <p style="font-size: 8pt; color: #6c757d; text-align: center; margin-top: 5px;">
            Détail par question disponible sur la plateforme.
        </p>
    </div>

    <h2>Détail des Compétences</h2>
    <div class="question-block" style="padding-bottom: 5px;">
        <h3>Pertinence & Clarté</h3>
        <div class="label">Pertinence Moyenne des Réponses</div>
        <div class="score-bar-container">
            <!-- On utilise 'or 0' comme sécurité si la valeur est None -->
            <div class="score-bar" style="width: {{ (data.global_scores.relevance_avg or 0) * 100 }}%;">{{ (data.global_scores.relevance_avg or 0) * 100 | round(0) }}%</div>
        </div>
        <div class="label" style="margin-top: 10px;">Clarté (Grammaire) Moyenne</div>
        <div class="score-bar-container">
            <div class="score-bar" style="width: {{ (data.global_scores.grammar_avg or 0) * 100 }}%;">{{ (data.global_scores.grammar_avg or 0) * 100 | round(0) }}%</div>
        </div>
    </div>

    <h2>Analyse par Question</h2>
    {% for answer in data.detailed_answers %}
    <div class="question-block">
        <h3>Question {{ loop.index }}: {{ answer.question_intitule }}</h3>
        <blockquote>{{ answer.transcription or "Aucune réponse textuelle détectée." }}</blockquote>
        <div class="label">Score de Pertinence</div>
        <div class="score-bar-container">
            <div class="score-bar" style="width: {{ (answer.score_pertinence or 0) * 100 }}%;">{{ (answer.score_pertinence or 0) * 100 | round(0) }}%</div>
        </div>
        <div class="label" style="margin-top: 10px;">Score de Grammaire</div>
        <div class="score-bar-container">
            <div class="score-bar" style="width: {{ (answer.score_grammaire or 0) * 100 }}%;">{{ (answer.score_grammaire or 0) * 100 | round(0) }}%</div>
        </div>
        {% if answer.pertinence_explication %}
        <div class="rag-explanation-box">
            <strong>Justification de l'IA (RAG) :</strong> {{ answer.pertinence_explication }}
        </div>
        {% endif %}
    </div>
    {% endfor %}

    <!-- Section de Validation RH (ne s'affiche que si le rapport a été validé) -->
    {% if data.validation_info and data.validation_info.validated %}
    <div class="validation-section">
        <h2><span style="color: #198754;">✔</span> Validation et Commentaire RH</h2>
        <div class="commentaire-box">
            <p>{{ data.validation_info.commentaire_rh or "Aucun commentaire ajouté." }}</p>
        </div>
        <p class="footer-note">Ce rapport a été revu et validé par un recruteur.</p>
    </div>
    {% endif %}

</body>
</html>